#!/usr/bin/env ruby
require 'set'

require "bundler/setup"
require "lnp_api_tools"

# You can add fixtures and/or initialization code here to make experimenting
# with your gem easier. You can also use a different console, if you like.

# (If you use this, don't forget to add pry to your Gemfile!)
# require "pry"
# Pry.start

types = Set[]
messages = []

ARGF.each_line do |line|
  messages << case line
  when /^\s*$/
    # Empty string, ignoring it
    nil
  when /^\s*#/
    # Comment string, ignoring it
    nil
  when /^\s*msgtype,([\w\d]+),(\d+|0x[a-fA-F\d]+),?\s*(#.*)?$/
    # Message definition
    "  #{$2}: &#{$1}"
  when /^\s*msgdata,([\w\d]+),([\w\d]+),([\w\d]+),\s*(#.*)?$/
    types << $3
    "    - { name: #{$2}, type: *#{$3} }"
  when /^\s*msgdata,([\w\d]+),([\w\d]+),([\w\d]+),(\d+)\s*(#.*)?$/
    types << $3
    "    - { name: #{$2}, type: *#{$3}, len: #{$4} }"
  when /^\s*msgdata,([\w\d]+),([\w\d]+),([\w\d]+),(\w[\w\d]*)\s*(#.*)?$/
    types << $3
    "    - { name: #{$2}, type: *#{$3}, len_var: #{$4} }"
  when /^\s*msgdata,([\w\d]+),([\w\d]+),\?([\w\d]+),?\s*(#.*)?$/
    types << $3
    "    - { name: #{$2}, type: *#{$3}, optional: true }"
  when /^\s*msgdata,([\w\d]+),([\w\d]+),\?([\w\d]+),(\d+)\s*(#.*)?$/
    types << $3
    "    - { name: #{$2}, type: *#{$3}, optional: true, len: #{4} }"
  when /^\s*msgdata,([\w\d]+),([\w\d]+),\?([\w\d]+),(\w[\w\d]*)\s*(#.*)?$/
    types << $3
    "    - { name: #{$2}, type: *#{$3}, optional: true, len_var: #{4} }"
  when /^\s*msgdata,([\w\d]+),([\w\d]+),enum\s+([\w\d]+),(\w[\w\d]*)?\s*(#.*)?$/
    types << "u8"
    "    - { name: #{$2}, type: *u8, enum: #{$3}#{$4 ? ', len_var: ' + $4 : ''} }"
  else
    raise RuntimeError, "Unknown input: #{line}"
  end
end

puts "--- # LNP API definition file; autogenerated from c-lightning CSV API file"
puts "\ntypes:"
types.each do |type|
  snake = type
  pascal = type.split('_').collect(&:capitalize).join
  camel = pascal[0].downcase + pascal[1..-1]
  puts "  - &#{type} { snake: #{snake}, pascal: #{pascal}, camel: #{camel} }"
end

puts "\nmessages:"
puts messages.compact.join "\n"

puts "..."